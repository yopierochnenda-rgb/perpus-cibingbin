<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Sistem Terpadu SMPN 1 Cibingbin</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root {
            --primary-blue: #0d47a1;
            --accent-gold: #ffc107;
            --success: #2e7d32;
            --warning: #f57c00;
            --danger: #d32f2f;
            --dot-color: rgba(13, 71, 161, 0.05);
        }

        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f2f5; margin: 0; }
        
        /* Navbar / Tabs */
        .navbar { background: var(--primary-blue); padding: 10px; display: flex; gap: 10px; position: sticky; top: 0; z-index: 1000; }
        .nav-btn { padding: 10px 20px; border: none; background: rgba(255,255,255,0.1); color: white; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .nav-btn.active { background: white; color: var(--primary-blue); }

        .container { padding: 20px; max-width: 1200px; margin: auto; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Dashboard Styles */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card-ui { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        #reader { width: 100%; border-radius: 12px; overflow: hidden; background: #000; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: var(--primary-blue); color: white; }
        .status-box { padding: 15px; border-radius: 8px; margin-top: 10px; display: none; }
        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; }

        /* DESAIN KARTU ANDA (IdCardP.html) */
        #cardContainer { display: grid; grid-template-columns: repeat(2, 85.6mm); gap: 15px; justify-content: center; }
        .id-card { width: 85.6mm; height: 53.98mm; background: #fff; background-image: radial-gradient(var(--dot-color) 1.2px, transparent 1.2px); background-size: 5px 5px; border-radius: 3mm; border: 0.1mm solid #ccc; position: relative; overflow: hidden; box-sizing: border-box; display: inline-block; margin-bottom: 10px; text-align: left;}
        .blue-top-line { height: 1.5mm; background: var(--primary-blue); width: 100%; }
        .card-header { height: 13mm; display: flex; align-items: center; justify-content: space-between; padding: 0 4mm; position: relative; }
        .logo-side { height: 8mm; width: auto; }
        .logo-center { height: 9.5mm; width: auto; position: absolute; left: 50%; transform: translateX(-50%); }
        .separator-line { height: 0.5mm; background: var(--primary-blue); width: 90%; margin: 0 auto; }
        .card-title { text-align: center; margin: 1.5mm 0; }
        .card-title h1 { margin: 0; font-size: 8.5pt; color: var(--primary-blue); font-weight: 800; text-transform: uppercase; }
        .card-body { padding: 1.5mm 4mm; display: flex; justify-content: space-between; align-items: center; }
        .info-table { font-size: 6.5pt; border-collapse: collapse; width: 76%; }
        .label { color: #555; width: 22mm; }
        .data-value { color: #000; font-weight: 700; text-transform: uppercase; }
        .qr-wrapper { width: 16mm; height: 16mm; background: white; border: 0.1mm solid #eee; padding: 1mm; }
        .qr-code-img { width: 100%; height: 100%; }
        .back-content { padding: 0 4mm 4mm 4mm; display: flex; flex-direction: column; height: 100%; box-sizing: border-box;}
        .back-header { text-align: center; font-weight: 800; color: var(--primary-blue); font-size: 8.5pt; padding-bottom: 1.5mm; margin: 2mm 0; border-bottom: 0.5mm solid var(--primary-blue); }
        .rules-list { font-size: 6.5pt; color: #333; padding-left: 4.5mm; margin: 0; line-height: 1.3; }
        .staff-section { margin-top: 2mm; text-align: center; font-size: 6.5pt; color: #333; flex-grow: 1; }
        .quote-box { margin-top: auto; background: var(--primary-blue); padding: 1.8mm; text-align: center; font-weight: 800; font-size: 6.8pt; border-radius: 1mm; color: white; }

        @media print {
            .navbar, .no-print, #scanner-section { display: none !important; }
            body { background: none; padding: 0; }
            .tab-content { display: block !important; }
            #dashboard { display: none !important; }
            .id-card { -webkit-print-color-adjust: exact; box-shadow: none; border: 0.1mm solid #000; }
        }
    </style>
</head>
<body>

<div class="navbar">
    <button class="nav-btn active" onclick="openTab('dashboard')">üè† Dashboard Petugas</button>
    <button class="nav-btn" onclick="openTab('cetak')">üñ®Ô∏è Cetak Kartu</button>
</div>

<div class="container">
    
    <div id="dashboard" class="tab-content active">
        <div class="card-ui">
            <h3>1. Inisialisasi Database Siswa</h3>
            <input type="file" id="uploadDb" accept=".xlsx, .xls">
            <p id="dbStatus" style="color:red; font-weight:bold;">Database belum dimuat.</p>
        </div>

        <div class="grid">
            <div class="card-ui">
                <h3>2. Scan Kartu Kunjungan</h3>
                <div id="reader"></div>
                <button class="btn" style="background:var(--primary-blue); width:100%; margin-top:10px;" onclick="startScanner()">Buka Kamera</button>
                
                <div id="statusResult" class="status-box">
                    <h3 id="resNama" style="margin:0"></h3>
                    <p id="resKelas" style="margin:5px 0"></p>
                    <hr>
                    <p id="resStatus" style="font-weight:bold"></p>
                    <div id="actionPinjam" style="display:none; gap:10px; margin-top:10px;">
                        <input type="text" id="judulBuku" placeholder="Judul Buku..." style="padding:8px; flex-grow:1">
                        <button class="btn" style="background:var(--success)" onclick="simpanPinjam()">Pinjam</button>
                    </div>
                </div>
            </div>

            <div class="card-ui">
                <h3>3. Kunjungan Hari Ini</h3>
                <table id="tableKunjungan">
                    <thead><tr><th>Jam</th><th>Nama</th><th>Kelas</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="card-ui">
            <div style="display:flex; justify-content:space-between">
                <h3>4. Peminjaman Aktif</h3>
                <div style="font-size:12px">Denda/Hari: Rp <input type="number" id="tarifDenda" value="500" style="width:50px;" onchange="renderTables()"></div>
            </div>
            <table id="tablePinjam">
                <thead><tr><th>Nama</th><th>Buku</th><th>Status / Denda</th><th>Aksi</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="cetak" class="tab-content">
        <div class="card-ui no-print" style="text-align:center;">
            <p>Pastikan database excel sudah diupload di tab Dashboard.</p>
            <button class="btn" style="background:var(--accent-gold); color:black;" onclick="window.print()">CETAK KARTU KE PDF</button>
        </div>
        <div id="cardContainer"></div>
    </div>

</div>

<script>
let dbSiswa = JSON.parse(localStorage.getItem('db_perpus')) || [];
let dataPinjam = JSON.parse(localStorage.getItem('data_pinjam')) || [];
let dataKunjungan = [];
let html5QrCode = null;
let currentSiswa = null;

// Logo dari file Anda
const logoKiri = "https://i.postimg.cc/zvwCjX6D/Desain-tanpa-judul.png";
const logoTengah = "https://i.postimg.cc/0j0H3Lp8/logo-sekolah.png"; // Ganti jika perlu
const logoKanan = "https://cdn-icons-png.flaticon.com/512/3389/3389081.png";

function openTab(id) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    event.currentTarget.classList.add('active');
}

document.getElementById('uploadDb').addEventListener('change', function(e) {
    const reader = new FileReader();
    reader.onload = (event) => {
        const data = new Uint8Array(event.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        dbSiswa = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        localStorage.setItem('db_perpus', JSON.stringify(dbSiswa));
        initApp();
    };
    reader.readAsArrayBuffer(e.target.files[0]);
});

function initApp() {
    if(dbSiswa.length > 0) {
        document.getElementById('dbStatus').innerText = "‚úÖ Database Aktif: " + dbSiswa.length + " Siswa";
        document.getElementById('dbStatus').style.color = "green";
        renderTables();
        generateCards();
    }
}

function startScanner() {
    if(!html5QrCode) {
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => {
            handleScan(decodedText);
        });
    }
}

function handleScan(nis) {
    // Cari data siswa di database (mengabaikan spasi/huruf besar)
    const siswa = dbSiswa.find(s => String(s.NIS || s.NISN || s.nis || s.nisn).trim() === String(nis).trim());
    
    if(!siswa) {
        alert("Siswa dengan NIS " + nis + " tidak ditemukan!");
        return;
    }

    currentSiswa = siswa;
    const nama = siswa.Nama || siswa.NAMA;
    const kelas = siswa.Kelas || siswa.KELAS;

    // 1. Catat Kunjungan
    const waktu = new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
    dataKunjungan.unshift({ waktu, nama, kelas });

    // 2. Cek Status
    const statusBox = document.getElementById('statusResult');
    statusBox.style.display = "block";
    document.getElementById('resNama').innerText = nama;
    document.getElementById('resKelas').innerText = "Kelas: " + kelas;

    const pinjaman = dataPinjam.find(p => String(p.nis) === String(nis));
    if(pinjaman) {
        statusBox.style.background = "#fff3e0";
        document.getElementById('resStatus').innerHTML = "‚ö†Ô∏è SEDANG PINJAM: <br>" + pinjaman.buku;
        document.getElementById('resStatus').style.color = "var(--warning)";
        document.getElementById('actionPinjam').style.display = "none";
    } else {
        statusBox.style.background = "#e8f5e9";
        document.getElementById('resStatus').innerText = "‚úÖ STATUS BERSIH (SIAP PINJAM)";
        document.getElementById('resStatus').style.color = "var(--success)";
        document.getElementById('actionPinjam').style.display = "flex";
    }
    
    new Audio('https://www.soundjay.com/buttons/beep-07a.mp3').play();
    renderTables();
}

function simpanPinjam() {
    const buku = document.getElementById('judulBuku').value;
    if(!buku) return alert("Isi judul buku!");
    dataPinjam.push({
        id: Date.now(),
        nis: currentSiswa.NIS || currentSiswa.NISN,
        nama: currentSiswa.Nama || currentSiswa.NAMA,
        buku: buku,
        tgl: new Date().toISOString(),
        durasi: 7
    });
    localStorage.setItem('data_pinjam', JSON.stringify(dataPinjam));
    document.getElementById('statusResult').style.display = "none";
    document.getElementById('judulBuku').value = "";
    renderTables();
}

function renderTables() {
    const tarif = document.getElementById('tarifDenda').value;
    // Render Kunjungan
    document.querySelector("#tableKunjungan tbody").innerHTML = dataKunjungan.map(k => `<tr><td>${k.waktu}</td><td>${k.nama}</td><td>${k.kelas}</td></tr>`).join('');

    // Render Pinjam
    document.querySelector("#tablePinjam tbody").innerHTML = dataPinjam.map(p => {
        const tglHarus = new Date(p.tgl);
        tglHarus.setDate(tglHarus.getDate() + p.durasi);
        const sisa = Math.ceil((tglHarus - new Date()) / (1000 * 60 * 60 * 24));
        let status = sisa < 0 ? `<b style="color:red">Terlambat (Denda: Rp ${Math.abs(sisa) * tarif})</b>` : `<b style="color:green">Sisa ${sisa} Hari</b>`;
        return `<tr><td>${p.nama}</td><td>${p.buku}</td><td>${status}</td><td><button onclick="kembali(${p.id})">Kembali</button></td></tr>`;
    }).join('');
}

function kembali(id) {
    if(confirm("Konfirmasi pengembalian buku?")) {
        dataPinjam = dataPinjam.filter(p => p.id !== id);
        localStorage.setItem('data_pinjam', JSON.stringify(dataPinjam));
        renderTables();
    }
}

function generateCards() {
    const container = document.getElementById('cardContainer');
    container.innerHTML = "";
    dbSiswa.forEach(row => {
        const nama = row['Nama'] || row['NAMA'] || 'NAMA SISWA';
        const jk = row['Jenis Kelamin'] || row['JK'] || 'L/P';
        const nis = row['NIS'] || row['NISN'] || '00000000';
        const kelas = row['Kelas'] || row['KELAS'] || '-';
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${nis}`;

        container.innerHTML += `
            <div class="id-card">
                <div class="blue-top-line"></div>
                <div class="card-header">
                    <img src="${logoKiri}" class="logo-side">
                    <img src="${logoTengah}" class="logo-center">
                    <img src="${logoKanan}" class="logo-side">
                </div>
                <div class="separator-line"></div>
                <div class="card-title"><h1>KARTU ANGGOTA PERPUSTAKAAN</h1></div>
                <div class="card-body">
                    <table class="info-table">
                        <tr><td class="label">Nama</td><td>:</td><td class="data-value">${nama}</td></tr>
                        <tr><td class="label">Jenis Kelamin</td><td>:</td><td class="data-value">${jk}</td></tr>
                        <tr><td class="label">NIS</td><td>:</td><td class="data-value">${nis}</td></tr>
                        <tr><td class="label">Kelas</td><td>:</td><td class="data-value">${kelas}</td></tr>
                    </table>
                    <div class="qr-wrapper"><img src="${qrUrl}" class="qr-code-img"></div>
                </div>
            </div>
            <div class="id-card">
                <div class="blue-top-line"></div>
                <div class="back-content">
                    <div class="back-header">TATA TERTIB PERPUSTAKAAN</div>
                    <ul class="rules-list">
                        <li>Kartu wajib dibawa setiap kunjungan.</li>
                        <li>Peminjaman maksimal 2 buku / 1 minggu.</li>
                        <li>Keterlambatan dikenakan sanksi/denda.</li>
                        <li>Menjaga ketenangan di perpustakaan.</li>
                    </ul>
                    <div class="staff-section">
                        <div style="font-weight:bold; margin-bottom:5mm;">Petugas Perpustakaan</div>
                        <div>( ........................................ )</div>
                    </div>
                    <div class="quote-box">"MEMBACA ADALAH JENDELA DUNIA"</div>
                </div>
            </div>
        `;
    });
}

initApp();
</script>
</body>
</html>
