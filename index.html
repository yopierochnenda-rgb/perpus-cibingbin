<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Sistem Dashboard Perpustakaan - SMPN 1 Cibingbin</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #0d47a1; --success: #2e7d32; --danger: #d32f2f; }
        body { font-family: sans-serif; background: #f4f7f6; margin: 0; padding: 0; }
        
        /* Login */
        #loginPage { position: fixed; inset: 0; background: var(--primary); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .login-card { background: white; padding: 2rem; border-radius: 12px; width: 300px; text-align: center; }
        
        /* Layout */
        .navbar { background: var(--primary); padding: 1rem; color: white; display: flex; justify-content: space-between; align-items: center; }
        .container { padding: 20px; max-width: 1200px; margin: auto; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card-ui { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        #reader { width: 100%; border-radius: 10px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: var(--primary); color: white; }
        
        input, button { padding: 10px; margin: 5px 0; border-radius: 5px; border: 1px solid #ccc; }
        .btn-blue { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: bold; }
        
        /* Print Layout Presisi */
        #printArea { display: none; grid-template-columns: repeat(2, 85.6mm); gap: 5mm; padding: 10mm; justify-content: center; }
        .id-card-base { width: 85.6mm; height: 53.98mm; border: 0.2mm solid #000; border-radius: 3mm; position: relative; overflow: hidden; display: flex; flex-direction: column; background: white; box-sizing: border-box; }
        
        @media print {
            #mainApp, #loginPage { display: none !important; }
            #printArea { display: grid !important; }
            .id-card-base { -webkit-print-color-adjust: exact; page-break-inside: avoid; }
        }
    </style>
</head>
<body>

<div id="loginPage">
    <div class="login-card">
        <h3>Dashboard Perpus</h3>
        <input type="password" id="pass" placeholder="Password (admin123)" style="width:100%">
        <button onclick="doLogin()" class="btn-blue" style="width:100%; margin-top:10px;">MASUK</button>
    </div>
</div>

<div id="mainApp" style="display:none">
    <div class="navbar">
        <b>SMPN 1 CIBINGBIN - SISTEM TERPADU</b>
        <button onclick="location.reload()" style="background:red; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">Keluar</button>
    </div>

    <div class="container">
        <div class="grid">
            <div class="card-ui">
                <h3>üì∑ Scanner Kunjungan</h3>
                <div id="reader"></div>
                <div id="scanMsg" style="margin-top:10px; padding:10px; border-radius:5px; display:none; font-weight:bold;"></div>
            </div>
            
            <div class="card-ui">
                <h3>‚ûï Input Siswa Baru</h3>
                <input type="text" id="inNama" placeholder="Nama Lengkap" style="width:90%">
                <input type="text" id="inNIS" placeholder="NIS/NISN" style="width:90%">
                <input type="text" id="inKelas" placeholder="Kelas" style="width:90%">
                <button onclick="saveSiswa()" class="btn-blue" style="width:95%">Simpan & Update Daftar Cetak</button>
                <hr>
                <small>Atau Upload Excel:</small><br>
                <input type="file" id="upEx" accept=".xlsx, .xls">
            </div>
        </div>

        <div class="card-ui">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <h3>üìä Laporan Hari Ini</h3>
                <button onclick="downloadExcel()" style="background:var(--success); color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer;">Download Excel</button>
            </div>
            <table id="logTable">
                <thead><tr><th>Waktu</th><th>Nama</th><th>Kelas</th><th>Metode</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="card-ui" style="text-align:center">
            <h3>üñ®Ô∏è Cetak Kartu Baru</h3>
            <p>Jika ada siswa baru, cetak di sini. Ukuran sudah sama dengan kartu lama (KTP).</p>
            <button onclick="window.print()" class="btn-blue" style="background:orange; color:black">PRINT SEMUA KARTU (A4)</button>
        </div>
    </div>
</div>

<div id="printArea"></div>

<script>
let db = JSON.parse(localStorage.getItem('db_perpus')) || [];
let logs = [];

function doLogin() {
    if(document.getElementById('pass').value === 'admin123') {
        document.getElementById('loginPage').style.display='none';
        document.getElementById('mainApp').style.display='block';
        startScanner();
        renderCetak();
    } else { alert("Password Salah!"); }
}

function startScanner() {
    const html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
        handleScan(text);
    });
}

function handleScan(text) {
    let nisScan = "";
    
    // LOGIKA PENDETEKSI KARTU LAMA (Jika ada teks 'NIS:')
    if(text.includes("NIS:")) {
        nisScan = text.split("NIS:")[1].split("|")[0].trim();
    } else {
        nisScan = text.trim();
    }

    const siswa = db.find(s => String(s.NIS || s.NISN || s.nis).trim() === nisScan);
    const msg = document.getElementById('scanMsg');
    msg.style.display = "block";

    if(siswa) {
        msg.style.background = "#e8f5e9"; msg.style.color = "green";
        msg.innerText = "‚úÖ BERHASIL: " + (siswa.Nama || siswa.NAMA);
        logs.unshift({ Waktu: new Date().toLocaleTimeString(), Nama: (siswa.Nama || siswa.NAMA), Kelas: (siswa.Kelas || siswa.KELAS), Metode: "Scan Kartu" });
        updateLogTable();
        new Audio('https://www.soundjay.com/buttons/beep-07a.mp3').play();
    } else {
        msg.style.background = "#ffebee"; msg.style.color = "red";
        msg.innerText = "‚ùå NIS TIDAK ADA DI DATA: " + nisScan;
    }
}

function saveSiswa() {
    const n = document.getElementById('inNama').value;
    const ni = document.getElementById('inNIS').value;
    const k = document.getElementById('inKelas').value;
    if(!n || !ni) return alert("Isi Nama & NIS");
    db.push({ Nama: n, NIS: ni, Kelas: k });
    localStorage.setItem('db_perpus', JSON.stringify(db));
    alert("Tersimpan!");
    renderCetak();
}

function updateLogTable() {
    document.querySelector("#logTable tbody").innerHTML = logs.map(l => `<tr><td>${l.Waktu}</td><td>${l.Nama}</td><td>${l.Kelas}</td><td>${l.Metode}</td></tr>`).join('');
}

function downloadExcel() {
    const ws = XLSX.utils.json_to_sheet(logs);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Kunjungan");
    XLSX.writeFile(wb, "Laporan_Perpus.xlsx");
}

function renderCetak() {
    const area = document.getElementById('printArea');
    area.innerHTML = "";
    db.forEach(s => {
        const qr = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${s.NIS || s.NISN}`;
        area.innerHTML += `
            <div class="id-card-base" style="padding:10px; font-size:8pt">
                <center><b>KARTU PERPUSTAKAAN</b></center><hr>
                Nama: ${s.Nama || s.NAMA}<br>NIS: ${s.NIS || s.NISN}<br>Kelas: ${s.Kelas || s.KELAS}
                <div style="position:absolute; bottom:10px; right:10px; width:15mm; height:15mm;">
                    <img src="${qr}" style="width:100%">
                </div>
            </div>
            <div class="id-card-base" style="padding:10px; font-size:7pt">
                <center><b>TATA TERTIB</b></center>
                <ul><li>Bawa kartu saat berkunjung</li><li>Jaga ketenangan</li></ul>
            </div>`;
    });
}
</script>
</body>
</html>
