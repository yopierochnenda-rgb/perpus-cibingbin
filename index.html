<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Perpus SMPN 1 Cibingbin</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: sans-serif; text-align: center; margin: 20px; background: #f0f2f5; }
        #reader { width: 100%; max-width: 500px; margin: auto; background: white; padding: 10px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .buttons { margin: 20px 0; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        button { padding: 12px 20px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; transition: 0.3s; }
        .btn-hadir { background: #007bff; color: white; }
        .btn-pinjam { background: #ffc107; color: black; }
        .btn-kembali { background: #28a745; color: white; }
        button.active { outline: 4px solid #333; transform: scale(1.05); }
        #status-msg { margin: 15px; padding: 10px; font-weight: bold; }
        .monitor-section { margin-top: 30px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 600px; margin-inline: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #f8f9fa; }
        .loading { color: #888; font-style: italic; }
    </style>
</head>
<body>

    <h2>ðŸ“š Perpus SMPN 1 Cibingbin</h2>
    
    <div class="buttons">
        <button id="btn-hadir" class="btn-hadir" onclick="setStatus('Kunjungan')">KUNJUNGAN</button>
        <button id="btn-pinjam" class="btn-pinjam" onclick="setStatus('Pinjam')">PINJAM</button>
        <button id="btn-kembali" class="btn-kembali" onclick="setStatus('Kembali')">KEMBALI</button>
    </div>

    <div id="reader"></div>
    <div id="status-msg">Silakan pilih mode (Kunjungan/Pinjam/Kembali)</div>

    <div class="monitor-section">
        <h3>ðŸ“Š Daftar Belum Kembali</h3>
        <table id="peminjaman-table">
            <thead>
                <tr>
                    <th>Nama</th>
                    <th>Kelas</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="peminjaman-body">
                <tr><td colspan="3" class="loading">Memuat data...</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbz3AryEjqVcnPdwMseCci2sgdUdNWJ3jPXXSvmPSUISZADK9S9gYcPF7ARdOnRFn3Dr/exec";
        let currentStatus = "";

        function setStatus(status) {
            currentStatus = status;
            document.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            if(status === 'Kunjungan') document.getElementById('btn-hadir').classList.add('active');
            if(status === 'Pinjam') document.getElementById('btn-pinjam').classList.add('active');
            if(status === 'Kembali') document.getElementById('btn-kembali').classList.add('active');
            document.getElementById('status-msg').innerText = "Mode: " + status + " | Siap Scan...";
        }

        function onScanSuccess(decodedText) {
            if (!currentStatus) {
                alert("Pilih mode (Kunjungan/Pinjam/Kembali) dulu!");
                return;
            }

            document.getElementById('status-msg').innerText = "Mengirim data...";
            
            fetch(URL_SCRIPT, {
                method: "POST",
                body: JSON.stringify({ id: decodedText, status: currentStatus }),
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('status-msg').innerText = "âœ… Berhasil: " + data.nama + " (" + currentStatus + ")";
                refreshMonitor(); // Update tabel setelah scan
            })
            .catch(err => {
                document.getElementById('status-msg').innerText = "âŒ Gagal mengirim data.";
                console.error(err);
            });
        }

        // FUNGSI UNTUK MENAMPILKAN DATA DI MONITOR
        function refreshMonitor() {
            fetch(URL_SCRIPT + "?action=read")
            .then(res => res.json())
            .then(data => {
                const body = document.getElementById('peminjaman-body');
                body.innerHTML = "";
                const dipinjam = data.filter(item => item.status === "Pinjam");
                
                if (dipinjam.length === 0) {
                    body.innerHTML = "<tr><td colspan='3'>Semua buku sudah kembali</td></tr>";
                } else {
                    dipinjam.forEach(item => {
                        body.innerHTML += `<tr><td>${item.nama}</td><td>${item.kelas}</td><td style='color:orange'>Pinjam</td></tr>`;
                    });
                }
            });
        }

        let html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
        html5QrcodeScanner.render(onScanSuccess);
        
        // Jalankan monitor saat halaman dibuka
        refreshMonitor();
    </script>
</body>
</html>
